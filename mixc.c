#include <stdint.h>

static volatile uint64_t v[16] = {
	0xb8dab0e6dad09901,
	0xcf03c5c600757ab7,
	0xdfacb1f9d9c57a93,
	0xfee2361fbf786127,
	0x99d13298ec49cd87,
	0x918b11fad70c90af,
	0xf8c12d8a31e521ef,
	0x8c308be5ba069c03,
	0x9f2afdcc19f4d225,
	0x8524cd5a09dd64e1,
	0xe77681347ec6afb3,
	0xe89a921bb73bcd33,
	0xea79de676052bfad,
	0x98d60534a88e1455,
	0xe2ddb16b4735f3b5,
	0x8fad663889763fe5
};

static uint64_t m[16] = {
	0xfa178d7aea611c31,
	0x906be21bf1df56d5,
	0xcb84ea155d209ae9,
	0xf33f2e35821fa05f,
	0xbc8873b0c6a9216f,
	0xf50bfb78e5aac2ab,
	0xf59059b1a358e425,
	0xbbf436c25f04b11b,
	0xcd8a68ce90485ff9,
	0xe37fc528939a9e07,
	0x9c34eabceaf3be8d,
	0x9c61750f270e0107,
	0xa5ce2259f17dd9e5,
	0xd8b677d238d03555,
	0xd611b10485d34eef,
	0x807ce600be072f3d
};

static uint64_t ror(uint64_t v, int n) {
	return v >> n | v << (32 - n);
}

// Mixing Function G from BLAKE2B
static void G(int a, int b, int c, int d, uint64_t x, uint64_t y) {

	v[a] += v[b] + x;
	ror(v[d] ^= v[a], 32);
	v[c] += v[d];
	ror(v[b] ^= v[c], 24);
	v[a] += v[b] + y;
	ror(v[d] ^= v[a], 16);
	v[c] += v[d];
	ror(v[b] ^= v[c], 63);
}

static int mix(int i) {

	v[0] += i;

	// loop over inner mixing block of BLAKE2B compression function with arbitrary input
	for (int i=0; i < 10000; ++i) {

		G(0, 4, 8, 12, m[0], m[1]);
		G(1, 5, 9, 13, m[2], m[3]);
		G(2, 6, 10, 14, m[4], m[5]);
		G(3, 7, 11, 15, m[6], m[7]);
		G(0, 5, 10, 15, m[8], m[9]);
		G(1, 6, 11, 12, m[10], m[11]);
		G(2, 7, 8, 13, m[12], m[13]);
		G(3, 4, 9, 14, m[14], m[15]);

		G(0, 4, 8, 12, m[14], m[10]);
		G(1, 5, 9, 13, m[4], m[8]);
		G(2, 6, 10, 14, m[9], m[15]);
		G(3, 7, 11, 15, m[13], m[6]);
		G(0, 5, 10, 15, m[1], m[12]);
		G(1, 6, 11, 12, m[0], m[2]);
		G(2, 7, 8, 13, m[11], m[7]);
		G(3, 4, 9, 14, m[5], m[3]);

		G(0, 4, 8, 12, m[11], m[8]);
		G(1, 5, 9, 13, m[12], m[0]);
		G(2, 6, 10, 14, m[5], m[2]);
		G(3, 7, 11, 15, m[15], m[13]);
		G(0, 5, 10, 15, m[10], m[14]);
		G(1, 6, 11, 12, m[3], m[6]);
		G(2, 7, 8, 13, m[7], m[1]);
		G(3, 4, 9, 14, m[9], m[4]);

		G(0, 4, 8, 12, m[7], m[9]);
		G(1, 5, 9, 13, m[3], m[1]);
		G(2, 6, 10, 14, m[13], m[12]);
		G(3, 7, 11, 15, m[11], m[14]);
		G(0, 5, 10, 15, m[2], m[6]);
		G(1, 6, 11, 12, m[5], m[10]);
		G(2, 7, 8, 13, m[4], m[0]);
		G(3, 4, 9, 14, m[15], m[8]);

		G(0, 4, 8, 12, m[9], m[0]);
		G(1, 5, 9, 13, m[5], m[7]);
		G(2, 6, 10, 14, m[2], m[4]);
		G(3, 7, 11, 15, m[10], m[15]);
		G(0, 5, 10, 15, m[14], m[1]);
		G(1, 6, 11, 12, m[11], m[12]);
		G(2, 7, 8, 13, m[6], m[8]);
		G(3, 4, 9, 14, m[3], m[13]);

		G(0, 4, 8, 12, m[2], m[12]);
		G(1, 5, 9, 13, m[6], m[10]);
		G(2, 6, 10, 14, m[0], m[11]);
		G(3, 7, 11, 15, m[8], m[3]);
		G(0, 5, 10, 15, m[4], m[13]);
		G(1, 6, 11, 12, m[7], m[5]);
		G(2, 7, 8, 13, m[15], m[14]);
		G(3, 4, 9, 14, m[1], m[9]);

		G(0, 4, 8, 12, m[12], m[5]);
		G(1, 5, 9, 13, m[1], m[15]);
		G(2, 6, 10, 14, m[14], m[13]);
		G(3, 7, 11, 15, m[4], m[10]);
		G(0, 5, 10, 15, m[0], m[7]);
		G(1, 6, 11, 12, m[6], m[3]);
		G(2, 7, 8, 13, m[9], m[2]);
		G(3, 4, 9, 14, m[8], m[11]);

		G(0, 4, 8, 12, m[13], m[11]);
		G(1, 5, 9, 13, m[7], m[14]);
		G(2, 6, 10, 14, m[12], m[1]);
		G(3, 7, 11, 15, m[3], m[9]);
		G(0, 5, 10, 15, m[5], m[0]);
		G(1, 6, 11, 12, m[15], m[4]);
		G(2, 7, 8, 13, m[8], m[6]);
		G(3, 4, 9, 14, m[2], m[10]);

		G(0, 4, 8, 12, m[6], m[15]);
		G(1, 5, 9, 13, m[14], m[9]);
		G(2, 6, 10, 14, m[11], m[3]);
		G(3, 7, 11, 15, m[0], m[8]);
		G(0, 5, 10, 15, m[12], m[2]);
		G(1, 6, 11, 12, m[13], m[7]);
		G(2, 7, 8, 13, m[1], m[4]);
		G(3, 4, 9, 14, m[10], m[5]);

		G(0, 4, 8, 12, m[10], m[2]);
		G(1, 5, 9, 13, m[8], m[4]);
		G(2, 6, 10, 14, m[7], m[6]);
		G(3, 7, 11, 15, m[1], m[5]);
		G(0, 5, 10, 15, m[15], m[11]);
		G(1, 6, 11, 12, m[9], m[14]);
		G(2, 7, 8, 13, m[3], m[12]);
		G(3, 4, 9, 14, m[13], m[0]);

		G(0, 4, 8, 12, m[0], m[1]);
		G(1, 5, 9, 13, m[2], m[3]);
		G(2, 6, 10, 14, m[4], m[5]);
		G(3, 7, 11, 15, m[6], m[7]);
		G(0, 5, 10, 15, m[8], m[9]);
		G(1, 6, 11, 12, m[10], m[11]);
		G(2, 7, 8, 13, m[12], m[13]);
		G(3, 4, 9, 14, m[14], m[15]);

		G(0, 4, 8, 12, m[14], m[10]);
		G(1, 5, 9, 13, m[4], m[8]);
		G(2, 6, 10, 14, m[9], m[15]);
		G(3, 7, 11, 15, m[13], m[6]);
		G(0, 5, 10, 15, m[1], m[12]);
		G(1, 6, 11, 12, m[0], m[2]);
		G(2, 7, 8, 13, m[11], m[7]);
		G(3, 4, 9, 14, m[5], m[3]);
	}
	return v[4];
}

int main(int argc, char** argv) {
	return !mix(argc);
}
